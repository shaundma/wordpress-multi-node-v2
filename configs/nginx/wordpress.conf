# Trellis-inspired Nginx configuration for Bedrock WordPress
# Optimized for security and performance
# This file is included by ssl.conf which provides the server {} block

root /var/www/webroot/ROOT/current/web;

index index.php index.html;

# Character set
charset utf-8;

# Max upload size (matches PHP settings)
client_max_body_size 150m;

# FastCGI cache conditions
set $skip_cache 0;

# POST requests and URLs with query strings should always bypass cache
if ($request_method = POST) {
    set $skip_cache 1;
}

if ($query_string != "") {
    set $skip_cache 1;
}

# Don't cache URIs containing the following segments
if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
    set $skip_cache 1;
}

# Don't cache WooCommerce pages
if ($request_uri ~* "/winkelmand|/afrekenen|/mijn-account|/checkout|/cart|/my-account") {
    set $skip_cache 1;
}

# Don't use the cache for logged-in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
    set $skip_cache 1;
}

# Security headers
add_header Fastcgi-Cache $upstream_cache_status;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# Disable direct access to .env and other sensitive files
location ~ /\.(?!well-known).* {
    deny all;
}

# Include custom user configuration files
include conf.d/includes.d/*.conf;

# Prevent access to composer files
location ~ ^/(composer\.json|composer\.lock|\.editorconfig|\.gitignore|wp-cli\.yml)$ {
    deny all;
}

# Prevent access to vendor directory
location ~ ^/vendor/ {
    deny all;
}

# Prevent PHP execution in uploads
location ~* ^/app/uploads/.*\.php$ {
    deny all;
}

# Deny access to any files with .blade.php, .twig, or .hbs extensions
location ~* \.(blade\.php|twig|hbs)$ {
    deny all;
}

# WordPress: deny wp-content, wp-includes php files
location ~* ^/wp-(?:content|includes)/.*\.php$ {
    deny all;
}

# WordPress: deny wp-content/uploads nasty stuff
location ~* ^/wp-content/uploads/.*\.(?:s?html?|php|js|swf)$ {
    deny all;
}

# Protect WooCommerce PDF invoices from direct access
location ~* /wpo_wcpdf/.*\.pdf$ {
    deny all;
}

# WordPress: SEO plugin xmlrpc requests
location ~ ^/xmlrpc\.php$ {
    # Uncomment to disable XML-RPC completely
    # return 444;
    try_files $uri =404;
    fastcgi_pass unix:/var/run/php-fpm.socket;
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Assets, media
location ~* \.(?:css(\.map)?|js(\.map)?|jpe?g|png|gif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv)$ {
    expires 7d;
    access_log off;
    add_header Cache-Control "public, immutable";
}

# SVG, fonts
location ~* \.(?:svgz?|ttf|ttc|otf|eot|woff2?)$ {
    expires 7d;
    access_log off;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin "*";
}

# WordPress: deny general stuff
location ~* ^/(?:readme|license)\.(html|txt)$ {
    deny all;
}

# Cache static files
location ~* \.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
    expires max;
    log_not_found off;
    access_log off;
}

# Convenience redirects for admin access
location = /wp-admin {
    return 301 $scheme://$host/wp/wp-admin/;
}

location ~ ^/wp-admin/ {
    rewrite ^/wp-admin/(.*)$ /wp/wp-admin/$1 redirect;
}

location = /wp-login.php {
    return 301 $scheme://$host/wp/wp-login.php;
}

# Main WordPress location block
location / {
    try_files $uri $uri/ /index.php?$args;
}

# Handle PHP files
location ~ \.php$ {
    try_files $uri =404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass unix:/var/run/php-fpm.socket;
    fastcgi_index index.php;
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT $realpath_root;
    fastcgi_param PATH_INFO $fastcgi_path_info;

    # FastCGI cache settings
    fastcgi_cache wordpress;
    fastcgi_cache_valid 200 30s;
    fastcgi_cache_bypass $skip_cache;
    fastcgi_no_cache $skip_cache;

    # Increase timeouts for admin operations
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Buffer settings
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
}

# Nginx status for monitoring (restrict access in production)
location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
}
