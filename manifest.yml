jpsType: install
jpsVersion: '1.7.2'
id: wordpress-multinode
name: WordPress Multi-Node LEMP Stack
categories:
  - apps/blogs
  - apps/content-management
  - apps/wordpress
logo: https://raw.githubusercontent.com/shaundma/wordpress-multi-node-v2/main/images/wp-standalone.png
homepage: http://wordpress.org/
description:
  text: WordPress Multi-Node LEMP Stack following Roots.io Trellis architecture. Separate nodes for Nginx+PHP, MariaDB, and Redis for optimal performance and scalability.
  short: WordPress Multi-Node LEMP Stack with separate Nginx+PHP, MariaDB, and Redis nodes

baseUrl: https://raw.githubusercontent.com/shaundma/wordpress-multi-node-v2/main

onBeforeInit: /scripts/beforeInit.js?_r=${fn.random}
onBeforeInstall: /scripts/beforeInstall.js?_r=${fn.random}
nodes: definedInOnBeforeInstall

skipNodeEmails: true

settings:
  fields:
    - caption: PHP version
      type: list
      name: php_engine
      default: php8.4
      required: true
      width: 225
      values:
        - value: php8.4
          caption: PHP 8.4
        - value: php8.3
          caption: PHP 8.3
        - value: php8.2
          caption: PHP 8.2

    - caption: Advanced Features
      type: displayfield
      name: displayfield
      markup:

    - caption: Install WordPress
      type: checkbox
      name: wp-addon
      value: true
      disabled: false
      tooltip: "Install WordPress with Bedrock boilerplate. Disable this if you plan to deploy WordPress using your own deployment tools. The environment will still be configured with Nginx, MariaDB, and Redis ready for your deployment."

    - caption: Install WooCommerce
      type: checkbox
      name: woocommerce
      value: false
      disabled: false
      tooltip: "WooCommerce is a free open-source e-commerce plugin designed specifically for WordPress. This is a great platform for a store of any size. (Only applies if WordPress is installed)"

    - caption: Install WordPress Multisite Network
      type: checkbox
      name: mu-addon
      value: false
      disabled: false
      tooltip: "Multisite is a type of WordPress installation that allows you to create and manage a network of multiple websites from a single WordPress dashboard. This lets you easily make changes and keep all of your websites updated from one place. (Only applies if WordPress is installed)"

    - caption: Install Let's Encrypt SSL with Auto-Renewal
      type: checkbox
      name: le-addon
      value: true
      disabled: false
      tooltip: "Advanced integration with Let's Encrypt certificate authority that simplifies and automates the process of issuing, configuring and updating trusted custom SSL certificates."

    - caption: Install Lightning-Fast Premium CDN
      type: checkbox
      name: cdn-addon
      value: false
      hidden: true
      disabled: false
      tooltip: "Jelastic CDN is an HTTP/3 premium content delivery network of 160+ Super PoPs (points of presence) with bandwidth capacity up to 115 Tbps, advanced caching and acceleration strategies based on best-in-class IP Anycast technology."

    - type: displayfield
      hideLabel: true
      hidden: true
      name: bl_count   
      markup:

mixins:
 - https://raw.githubusercontent.com/shaundma/wordpress-multi-node-v2/main/configs/vers.yml
 - /scripts/common.yml

globals:
  isSingleDeploy: ${settings.isSingleDeploy:true}
  WP_CLUSTER_PATH: https://raw.githubusercontent.com/jelastic-jps/wordpress-cluster/v2.2.0
  DB_USER: ${settings.DB_USER:user-[fn.random]}
  DB_PASS: ${settings.DB_PASS:[fn.password(10)]}
  DB_HOST: sqldb
  REDIS_HOST: nosqldb
  REDIS_PORT: 6379
  PROTOCOL: http
  WP_ADMIN_PASS: ${settings.WP_ADMIN_PASS:[fn.password(10)]}
  SUCCESS: default

onInstall:
  - addLimits
  - addMetadata
  - getUserInfo
  - initLEsettings
  - setupNodes
  - if (${globals.isSingleDeploy}):
    - setProtocol
    - setDomain
    - getRedisPassword
    - configureRedis
    - setupBedrockNginx
    - if (${settings.wp-addon:true}):
      - createUserDB
      - installBedrock
      - if (${settings.mu-addon:false}): installMultisite
      - if (${settings.woocommerce:false}): installWoocommerce
    - if (${settings.wp-addon:false}):
      - setupSkeletonStructure
    - if (${settings.le-addon:false}):
      - installLEaddon
      - if (${settings.wp-addon:true}): setupLEdomain
    - if (${settings.cdn-addon:false}):
      - installCDN
      - if (${settings.wp-addon:true}): setupCDN
    - if (${settings.wp-addon:true}):
      - install:
        - jps: /scripts/events.jps?_r=${fn.random}
        - jps: ${globals.WP_CLUSTER_PATH}/scripts/addons.jps?_r=${fn.random}
    - if ('${settings.success_email}' != 'false'):
      - return:
          type: success
          message: /success/text/success-${globals.SUCCESS}.md?_r=${fn.random}
          email: /success/email/success-nginxphp-${globals.SUCCESS}.md?_r=${fn.random}

actions:

  addLimits:
    - env.nodegroup.ApplyData[cp]:
        data:
          validation:
            maxCount: 1
    - env.nodegroup.ApplyData[sqldb]:
        data:
          validation:
            maxCount: 1
    - env.nodegroup.ApplyData[nosqldb]:
        data:
          validation:
            maxCount: 1

  addMetadata:
    script: |
      var metadata = { project: "${settings.project:default}", projectScope: "${settings.projectScope:production}" };
      return api.env.control.ApplyEnvProperty ?
        api.env.control.ApplyEnvProperty('${env.name}', session, metadata) :
        api.env.control.ApplyNodeGroupData('${env.name}', session, 'cp', metadata);

  getUserInfo:
    script: |
      var resp = jelastic.users.account.GetUserInfo();
      if (resp.result != 0) return resp;

      var email = resp.email || 'admin@example.com';
      var username = email.split('@')[0];

      return {
        result: 0,
        onAfterReturn: {
          setGlobals: {
            WP_ADMIN_USER: username,
            WP_ADMIN_EMAIL: email
          }
        }
      };

  setProtocol:
    - script: |
        return {
          result:0,
          ssl: jelastic.billing.account.GetQuotas('environment.jelasticssl.enabled').array[0].value
        }
    - if (${response.ssl} || ${settings.le-addon:false}):
        setGlobals:
          PROTOCOL: https

  setDomain:
    - script: ${globals.WP_CLUSTER_PATH}/scripts/idna.js
      domains: ${env.domain}
    - setGlobals:
        DOMAIN: ${response.domains} 

  installLEaddon:
    - install: https://github.com/jelastic-jps/lets-encrypt/blob/master/manifest.jps?_r=${fn.random}
      nodeGroup: cp
      skipEmail: true
      settings:
        test: false
        skipEmail: true
        fallbackToX1: true
        withExtIp: ${globals.isExtIP}

  initLEsettings:
    - script: |
        return {
          result:0,
          extIP: Boolean(jelastic.billing.account.GetQuotas('environment.externalip.enabled').array[0].value)
        }
    - setGlobals:
        isExtIP: ${response.extIP}

    - cmd[cp]: |-
        [ ! -d /var/lib/jelastic/keys/letsencrypt ] && mkdir -p /var/lib/jelastic/keys/letsencrypt;
        echo "webroot=true" > /var/lib/jelastic/keys/letsencrypt/settings-custom;
        echo "webrootPath=/var/www/webroot/ROOT/current/web" >> /var/lib/jelastic/keys/letsencrypt/settings-custom;
        echo "test=false" >> /var/lib/jelastic/keys/letsencrypt/settings-custom;
        echo "withExtIp=${globals.isExtIP}" >> /var/lib/jelastic/keys/letsencrypt/settings-custom;
      user: root

  setupLEdomain:
    - cmd[cp]: |-
        cd /var/www/webroot/ROOT

        # Get the domain from Let's Encrypt settings
        source /opt/letsencrypt/settings

        # Check if multisite - skip search-replace for multisite
        if ! wp core is-installed --network --allow-root; then
          # Get current URLs
          OLD_URL=$(wp option get home --allow-root)
          OLD_DOMAIN=$(echo $OLD_URL | cut -d'/' -f3)
          NEW_URL="https://${domain}"
          NEW_DOMAIN="${domain}"

          echo "Updating WordPress URLs from $OLD_URL to $NEW_URL"

          # Search and replace old URLs with new HTTPS URLs throughout database
          wp search-replace "$OLD_URL" "$NEW_URL" --skip-columns=guid --all-tables --allow-root

          # Also replace short domain (for protocol-relative URLs)
          wp search-replace "$OLD_DOMAIN" "$NEW_DOMAIN" --skip-columns=guid --all-tables --allow-root

          # Update .env file
          sed -i "s|WP_HOME=http://|WP_HOME=https://|g" .env
          sed -i "s|WP_SITEURL=http://|WP_SITEURL=https://|g" .env

          # Flush caches
          wp cache flush --allow-root || true
          wp redis enable --allow-root || true

          echo "WordPress URLs updated to HTTPS successfully"
        else
          echo "Multisite detected - skipping automatic URL update"
        fi

  installCDN:
    - install: https://raw.githubusercontent.com/jelastic-jps/cdn/master/manifest.yml?_r=${fn.random}
      nodeGroup: cp
      skipEmail: true
      settings:
        note: ${settings.noteCDN:}
  
  setupCDN:
    - script: return jelastic.dev.scripting.Eval("c05ffa5b45628a2a0c95467ebca8a0b4", session, "cdn.info", {partnerCode:1})
    - setGlobals:
        CDN_URL: ${globals.PROTOCOL}://${env.envName}-${response.response.partnerCode}.cdn.jelastic.net/
        CDN: ${env.envName}-${response.response.partnerCode}.cdn.jelastic.net
        SUCCESS: cdn
    - install: ${globals.WP_CLUSTER_PATH}/scripts/setupCDN.jps
  
  installMultisite:
    - install: ${globals.WP_CLUSTER_PATH}/addons/multisite.jps

  setupBedrockNginx:
    - log: "Setting up Trellis Nginx configuration for Bedrock"
    - install: /scripts/setupNginx.jps?_r=${fn.random}

  installBedrock:
    - log: "Installing Bedrock WordPress"
    - install: /scripts/installBedrock.jps?_r=${fn.random}
      settings:
        db_host: ${globals.DB_HOST}
        db_user: ${globals.DB_USER}
        db_pass: ${globals.DB_PASS}
        redis_host: ${globals.REDIS_HOST}
        redis_port: ${globals.REDIS_PORT}
        redis_pass: ${globals.REDIS_PASS}
        wp_admin_user: ${globals.WP_ADMIN_USER}
        wp_admin_pass: ${globals.WP_ADMIN_PASS}
        wp_admin_email: ${globals.WP_ADMIN_EMAIL}
        wp_title: "Hello World"
        wp_url: ${globals.PROTOCOL}://${globals.DOMAIN}

  setupSkeletonStructure:
    - log: "Setting up skeleton directory structure for custom deployment"
    - cmd[cp]: |-
        WEBROOT="/var/www/webroot/ROOT"

        # Create Bedrock-style directory structure
        mkdir -p $WEBROOT/releases/1/web/wp
        mkdir -p $WEBROOT/shared/uploads
        mkdir -p $WEBROOT/releases/1/config

        # Create symlink from current to releases/1
        cd $WEBROOT
        ln -sfn $WEBROOT/releases/1 current

        # Create symlink from web/app/uploads to shared/uploads
        cd $WEBROOT/current/web
        mkdir -p app
        cd app
        ln -sfn $WEBROOT/shared/uploads uploads

        # Create default index.php using echo to avoid heredoc issues
        cat > $WEBROOT/current/web/wp/index.php << 'ENDOFFILE'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Welcome - Environment Ready</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    min-height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: #fff;
                }
                .container {
                    text-align: center;
                    padding: 2rem;
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                    max-width: 600px;
                }
                h1 {
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }
                p {
                    font-size: 1.1rem;
                    line-height: 1.6;
                    margin-bottom: 1rem;
                }
                .info-box {
                    background: rgba(255, 255, 255, 0.2);
                    padding: 1.5rem;
                    border-radius: 10px;
                    margin-top: 2rem;
                    text-align: left;
                }
                .info-box h2 {
                    font-size: 1.3rem;
                    margin-bottom: 1rem;
                }
                .info-item {
                    margin-bottom: 0.5rem;
                }
                code {
                    background: rgba(0, 0, 0, 0.3);
                    padding: 0.2rem 0.5rem;
                    border-radius: 4px;
                    font-family: 'Courier New', monospace;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ Environment Ready!</h1>
                <p>Your LEMP stack (Nginx, MariaDB, Redis) is configured and ready for deployment.</p>
                <p>Deploy your WordPress application to get started.</p>

                <div class="info-box">
                    <h2>üìÅ Directory Structure</h2>
                    <div class="info-item">Document Root: <code>/var/www/webroot/ROOT/current/web</code></div>
                    <div class="info-item">Shared Files: <code>/var/www/webroot/ROOT/shared</code></div>
                    <div class="info-item">Credentials: <code>/var/www/webroot/ROOT/shared/.env</code></div>
                </div>

                <div class="info-box">
                    <h2>üîß Services Available</h2>
                    <div class="info-item">‚úÖ Nginx web server</div>
                    <div class="info-item">‚úÖ PHP-FPM</div>
                    <div class="info-item">‚úÖ MariaDB database</div>
                    <div class="info-item">‚úÖ Redis object cache</div>
                </div>
            </div>
        </body>
        </html>
        ENDOFFILE

        # Create .env file with credentials in shared directory
        cat > $WEBROOT/shared/.env << 'ENVEOF'
        # Database Configuration
        DB_NAME=wordpress
        DB_USER=DB_USER_PLACEHOLDER
        DB_PASSWORD=DB_PASS_PLACEHOLDER
        DB_HOST=DB_HOST_PLACEHOLDER
        DB_PREFIX=wp_

        # WordPress URLs (update these with your actual domain)
        WP_ENV=production
        WP_HOME=WP_HOME_PLACEHOLDER
        WP_SITEURL=WP_SITEURL_PLACEHOLDER

        # Redis Configuration
        REDIS_HOST=REDIS_HOST_PLACEHOLDER
        REDIS_PORT=REDIS_PORT_PLACEHOLDER
        REDIS_PASSWORD=REDIS_PASS_PLACEHOLDER
        REDIS_SCHEME=tcp
        REDIS_DATABASE=0
        REDIS_TIMEOUT=1
        REDIS_READ_TIMEOUT=1

        # Generate your own security keys at: https://roots.io/salts.html
        # Then add them here when deploying your application
        ENVEOF

        # Remove leading whitespace from .env (from heredoc indentation)
        sed -i 's/^[[:space:]]*//;s/[[:space:]]*$//' $WEBROOT/shared/.env

        # Replace placeholders in .env with actual values
        sed -i "s|DB_USER_PLACEHOLDER|${globals.DB_USER}|g" $WEBROOT/shared/.env
        sed -i "s|DB_PASS_PLACEHOLDER|${globals.DB_PASS}|g" $WEBROOT/shared/.env
        sed -i "s|DB_HOST_PLACEHOLDER|${globals.DB_HOST}|g" $WEBROOT/shared/.env
        sed -i "s|WP_HOME_PLACEHOLDER|${globals.PROTOCOL}://${globals.DOMAIN}|g" $WEBROOT/shared/.env
        sed -i "s|WP_SITEURL_PLACEHOLDER|${globals.PROTOCOL}://${globals.DOMAIN}/wp|g" $WEBROOT/shared/.env
        sed -i "s|REDIS_HOST_PLACEHOLDER|${globals.REDIS_HOST}|g" $WEBROOT/shared/.env
        sed -i "s|REDIS_PORT_PLACEHOLDER|${globals.REDIS_PORT}|g" $WEBROOT/shared/.env
        sed -i "s|REDIS_PASS_PLACEHOLDER|${globals.REDIS_PASS}|g" $WEBROOT/shared/.env

        # Create symlink from current/.env to shared/.env
        cd $WEBROOT/current
        ln -sfn $WEBROOT/shared/.env .env

        # Set proper permissions
        chown -R nginx:nginx $WEBROOT
        find $WEBROOT -type d -exec chmod 755 {} \;
        find $WEBROOT -type f -exec chmod 644 {} \;
        chmod 600 $WEBROOT/shared/.env

        echo "Skeleton directory structure created successfully"
        echo "Credentials stored in: $WEBROOT/shared/.env"
        ls -la $WEBROOT/
      user: root

  setupNodes:
    - log: "Setup Application Node"
    - install: https://raw.githubusercontent.com/jelastic/templates/master/config_v2.jps?_r=${fn.random}
      settings:
        targetGroup: cp
        optimization: wordpress
    - log: "Enable Redis, igbinary, intl, gd, and imagick PHP extensions"
    - cmd[cp]: |-
        # Enable igbinary PHP extension (required by Redis)
        sed -i 's/^;extension=igbinary.so/extension=igbinary.so/' /etc/php.ini

        # Enable Redis PHP extension
        sed -i 's/^;extension=redis.so/extension=redis.so/' /etc/php.ini

        # Enable intl, gd, and imagick extensions
        sed -i 's/^;extension=intl.so/extension=intl.so/' /etc/php.ini
        sed -i 's/^;extension=gd.so/extension=gd.so/' /etc/php.ini
        sed -i 's/^;extension=imagick.so/extension=imagick.so/' /etc/php.ini

        # Verify extensions are enabled
        if grep -q "^extension=igbinary.so" /etc/php.ini; then
          echo "igbinary PHP extension enabled"
        else
          echo "ERROR: Failed to enable igbinary PHP extension"
          exit 1
        fi

        if grep -q "^extension=redis.so" /etc/php.ini; then
          echo "Redis PHP extension enabled"
        else
          echo "ERROR: Failed to enable Redis PHP extension"
          exit 1
        fi

        if grep -q "^extension=intl.so" /etc/php.ini; then
          echo "intl PHP extension enabled"
        else
          echo "ERROR: Failed to enable intl PHP extension"
          exit 1
        fi

        if grep -q "^extension=gd.so" /etc/php.ini; then
          echo "gd PHP extension enabled"
        else
          echo "ERROR: Failed to enable gd PHP extension"
          exit 1
        fi

        if grep -q "^extension=imagick.so" /etc/php.ini; then
          echo "imagick PHP extension enabled"
        else
          echo "ERROR: Failed to enable imagick PHP extension"
          exit 1
        fi

        # Restart PHP-FPM to apply changes
        systemctl restart php-fpm
        echo "PHP-FPM restarted with Redis, igbinary, intl, gd, and imagick extensions"
      user: root
    - log: "Setup Database Node"
    - cmd[sqldb]: |-
        wget ${baseUrl}/configs/sqldb/wordpress.cnf -O /etc/mysql/conf.d/wordpress.cnf &>> /var/log/run.log || true
        systemctl restart mysql
      user: root
    - log: "Setup Redis Node"
    - cmd[nosqldb]: |-
        echo "maxmemory 256mb" >> /etc/redis.conf
        echo "maxmemory-policy allkeys-lru" >> /etc/redis.conf
        systemctl restart redis
      user: root
        
  createUserDB:
    - log: Create user and database
    - cmd[sqldb]: |-
        echo "Setting up database user and creating wordpress database..."

        # Get MySQL root password from Jelastic
        ROOT_PASS=$(awk -F "=" '/password/ {print $2}' /root/.my.cnf 2>/dev/null | tr -d ' ' | tr -d '\n')

        if [ -z "$ROOT_PASS" ]; then
          # Try alternative location
          ROOT_PASS=$(cat /var/lib/jelastic/keys/password.txt 2>/dev/null | tr -d '\n')
        fi

        if [ -z "$ROOT_PASS" ]; then
          echo "ERROR: Could not find MySQL root password"
          exit 1
        fi

        echo "Found MySQL root password"

        # Create wordpress database
        echo "Creating wordpress database..."
        mysql -uroot -p"$ROOT_PASS" -e "CREATE DATABASE IF NOT EXISTS wordpress CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>&1

        if [ $? -eq 0 ]; then
          echo "Database 'wordpress' created successfully"
        else
          echo "ERROR: Failed to create wordpress database"
          exit 1
        fi

        # Verify database exists
        DB_EXISTS=$(mysql -uroot -p"$ROOT_PASS" -e "SHOW DATABASES LIKE 'wordpress';" | grep wordpress)
        if [ -z "$DB_EXISTS" ]; then
          echo "ERROR: Database 'wordpress' does not exist after creation"
          exit 1
        fi
        echo "Verified: Database 'wordpress' exists"

        # Create user and grant privileges
        echo "Creating user ${globals.DB_USER} and granting privileges..."
        mysql -uroot -p"$ROOT_PASS" -e "CREATE USER IF NOT EXISTS '${globals.DB_USER}'@'%' IDENTIFIED BY '${globals.DB_PASS}';" 2>&1
        mysql -uroot -p"$ROOT_PASS" -e "GRANT ALL PRIVILEGES ON wordpress.* TO '${globals.DB_USER}'@'%';" 2>&1
        mysql -uroot -p"$ROOT_PASS" -e "GRANT ALL PRIVILEGES ON *.* TO '${globals.DB_USER}'@'%';" 2>&1
        mysql -uroot -p"$ROOT_PASS" -e "FLUSH PRIVILEGES;" 2>&1

        # Verify user can access the database
        if mysql -u${globals.DB_USER} -p${globals.DB_PASS} -e "USE wordpress; SELECT 1;" 2>&1 | grep -q "1"; then
          echo "Verified: User ${globals.DB_USER} can access wordpress database"
        else
          echo "ERROR: User ${globals.DB_USER} cannot access wordpress database"
          echo "Testing connection details:"
          mysql -u${globals.DB_USER} -p${globals.DB_PASS} -e "SELECT USER(), DATABASE();" 2>&1
          exit 1
        fi

        # Set Jelastic password
        jem passwd set -p ${globals.DB_PASS} 2>&1 | grep -i "success"

        echo "Database setup completed successfully"
      user: root

  getRedisPassword:
    - log: Get Redis password
    - cmd[nosqldb]: |-
        # Extract Redis password from redis.conf
        REDIS_PASS=$(grep "^requirepass" /etc/redis.conf | awk '{print $2}' | tr -d '\n')

        if [ -z "$REDIS_PASS" ]; then
          echo "ERROR: Could not find Redis password in /etc/redis.conf"
          exit 1
        fi

        echo "$REDIS_PASS"
      user: root
    - script: |
        var output = "${response.out}".trim();
        return {
          result: 0,
          onAfterReturn: {
            setGlobals: {
              REDIS_PASS: output
            }
          }
        }

  configureRedis:
    - log: Configure Redis for WordPress
    - cmd[nosqldb]: |-
        redis-cli -a ${globals.REDIS_PASS} CONFIG SET maxmemory 256mb
        redis-cli -a ${globals.REDIS_PASS} CONFIG SET maxmemory-policy allkeys-lru
      user: root
      
  installWoocommerce:
    - log: "Installing WooCommerce for Bedrock"
    - cmd[${nodes.cp.master.id}]: |-
        cd /var/www/webroot/ROOT
        composer require wpackagist-plugin/woocommerce:${globals.version_woocommerce} &>> /var/log/run.log
        wp plugin activate woocommerce --allow-root &>> /var/log/run.log
      user: root

startPage: ${env.url}
