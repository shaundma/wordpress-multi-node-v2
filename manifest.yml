jpsType: install
jpsVersion: '1.7.2'
id: wordpress-multinode
name: WordPress Multi-Node LEMP Stack
categories:
  - apps/blogs
  - apps/content-management
  - apps/wordpress
logo: https://raw.githubusercontent.com/shaundma/wordpress-multi-node-v2/main/images/wp-standalone.png
homepage: http://wordpress.org/
description:
  text: WordPress Multi-Node LEMP Stack following Roots.io Trellis architecture. Separate nodes for Nginx+PHP, MariaDB, and Redis for optimal performance and scalability.
  short: WordPress Multi-Node LEMP Stack with separate Nginx+PHP, MariaDB, and Redis nodes

baseUrl: https://raw.githubusercontent.com/shaundma/wordpress-multi-node-v2/main

onBeforeInit: /scripts/beforeInit.js?_r=${fn.random}
onBeforeInstall: /scripts/beforeInstall.js?_r=${fn.random}
nodes: definedInOnBeforeInstall

skipNodeEmails: true

settings:
  fields:
    - caption: PHP version
      type: list
      name: php_engine
      default: php8.4
      required: true
      width: 225
      values:
        - value: php8.4
          caption: PHP 8.4
        - value: php8.3
          caption: PHP 8.3
        - value: php8.2
          caption: PHP 8.2

    - caption: Advanced Features
      type: displayfield
      name: displayfield
      markup:
             
    - caption: Install Let's Encrypt SSL with Auto-Renewal
      type: checkbox
      name: le-addon
      value: true
      disabled: false
      tooltip: "Advanced integration with Let's Encrypt certificate authority that simplifies and automates the process of issuing, configuring and updating trusted custom SSL certificates."

    - caption: Install Lightning-Fast Premium CDN
      type: checkbox
      name: cdn-addon
      value: false
      hidden: true
      disabled: false
      tooltip: "Jelastic CDN is an HTTP/3 premium content delivery network of 160+ Super PoPs (points of presence) with bandwidth capacity up to 115 Tbps, advanced caching and acceleration strategies based on best-in-class IP Anycast technology."

    - caption: Install WordPress Multisite Network
      type: checkbox
      name: mu-addon
      value: false
      disabled: false
      tooltip: "Multisite is a type of WordPress installation that allows you to create and manage a network of multiple websites from a single WordPress dashboard. This lets you easily make changes and keep all of your websites updated from one place."

    - caption: Install WooCommerce
      type: checkbox
      name: woocommerce
      value: false
      disabled: false
      tooltip: "WooCommerce is a free open-source e-commerce plugin designed specifically for WordPress. This is a great platform for a store of any size."

    - type: displayfield
      hideLabel: true
      hidden: true
      name: bl_count   
      markup:

mixins:
 - https://raw.githubusercontent.com/shaundma/wordpress-multi-node-v2/main/configs/vers.yml
 - /scripts/common.yml

globals:
  isSingleDeploy: ${settings.isSingleDeploy:true}
  WP_CLUSTER_PATH: https://raw.githubusercontent.com/jelastic-jps/wordpress-cluster/v2.2.0
  DB_USER: ${settings.DB_USER:user-[fn.random]}
  DB_PASS: ${settings.DB_PASS:[fn.password(10)]}
  DB_HOST: sqldb
  REDIS_HOST: nosqldb
  REDIS_PORT: 6379
  PROTOCOL: http
  WP_ADMIN_PASS: ${settings.WP_ADMIN_PASS:[fn.password(10)]}
  SUCCESS: default

onInstall:
  - addLimits
  - addMetadata
  - initLEsettings
  - setupNodes
  - if (${globals.isSingleDeploy}):
    - setProtocol
    - setDomain
    - createUserDB
    - configureRedis
    - setupBedrockNginx
    - installBedrock
    - if (${settings.mu-addon:false}): installMultisite
    - if (${settings.le-addon:false}):
      - installLEaddon
      - setupLEdomain
    - if (${settings.cdn-addon:false}):
      - installCDN
      - setupCDN
    - if (${settings.woocommerce:false}): installWoocommerce
    - install:
      - jps: /scripts/events.jps?_r=${fn.random}
      - jps: ${globals.WP_CLUSTER_PATH}/scripts/addons.jps?_r=${fn.random}
    - if ('${settings.success_email}' != 'false'):
      - return:
          type: success
          message: /success/text/success-${globals.SUCCESS}.md?_r=${fn.random}
          email: /success/email/success-nginxphp-${globals.SUCCESS}.md?_r=${fn.random}

actions:

  addLimits:
    - env.nodegroup.ApplyData[cp]:
        data:
          validation:
            maxCount: 1
    - env.nodegroup.ApplyData[sqldb]:
        data:
          validation:
            maxCount: 1
    - env.nodegroup.ApplyData[nosqldb]:
        data:
          validation:
            maxCount: 1

  addMetadata:
    script: |
      var metadata = { project: "${settings.project:default}", projectScope: "${settings.projectScope:production}" };
      return api.env.control.ApplyEnvProperty ?
        api.env.control.ApplyEnvProperty('${env.name}', session, metadata) :
        api.env.control.ApplyNodeGroupData('${env.name}', session, 'cp', metadata);

  setProtocol:
    - script: |
        return {
          result:0,
          ssl: jelastic.billing.account.GetQuotas('environment.jelasticssl.enabled').array[0].value
        }
    - if (${response.ssl} || ${settings.le-addon:false}):
        setGlobals:
          PROTOCOL: https

  setDomain:
    - script: ${globals.WP_CLUSTER_PATH}/scripts/idna.js
      domains: ${env.domain}
    - setGlobals:
        DOMAIN: ${response.domains} 

  installLEaddon:
    - install: https://github.com/jelastic-jps/lets-encrypt/blob/master/manifest.jps?_r=${fn.random}
      nodeGroup: cp
      skipEmail: true
      settings:
        test: false
        skipEmail: true
        fallbackToX1: true
        withExtIp: ${globals.isExtIP}

  initLEsettings:
    - script: |
        return {
          result:0,
          extIP: Boolean(jelastic.billing.account.GetQuotas('environment.externalip.enabled').array[0].value)
        }
    - setGlobals:
        isExtIP: ${response.extIP}

    - cmd[cp]: |-
        [ ! -d /var/lib/jelastic/keys/letsencrypt ] && mkdir -p /var/lib/jelastic/keys/letsencrypt;
        echo "webroot=true" > /var/lib/jelastic/keys/letsencrypt/settings-custom;
        echo "webrootPath=/var/www/webroot/ROOT/web" >> /var/lib/jelastic/keys/letsencrypt/settings-custom;
        echo "test=false" >> /var/lib/jelastic/keys/letsencrypt/settings-custom;
        echo "withExtIp=${globals.isExtIP}" >> /var/lib/jelastic/keys/letsencrypt/settings-custom;
      user: root

  setupLEdomain:
    - cmd[cp]: |-
        cd /var/www/webroot/ROOT

        # Get the domain from Let's Encrypt settings
        source /opt/letsencrypt/settings

        # Update WordPress site URL to use HTTPS
        wp option update home "https://${domain}" --allow-root
        wp option update siteurl "https://${domain}/wp" --allow-root

        # Also update .env file
        sed -i "s|WP_HOME=http://|WP_HOME=https://|g" .env
        sed -i "s|WP_SITEURL=http://|WP_SITEURL=https://|g" .env

        echo "WordPress URLs updated to use HTTPS"

  installCDN:
    - install: https://raw.githubusercontent.com/jelastic-jps/cdn/master/manifest.yml?_r=${fn.random}
      nodeGroup: cp
      skipEmail: true
      settings:
        note: ${settings.noteCDN:}
  
  setupCDN:
    - script: return jelastic.dev.scripting.Eval("c05ffa5b45628a2a0c95467ebca8a0b4", session, "cdn.info", {partnerCode:1})
    - setGlobals:
        CDN_URL: ${globals.PROTOCOL}://${env.envName}-${response.response.partnerCode}.cdn.jelastic.net/
        CDN: ${env.envName}-${response.response.partnerCode}.cdn.jelastic.net
        SUCCESS: cdn
    - install: ${globals.WP_CLUSTER_PATH}/scripts/setupCDN.jps
  
  installMultisite:
    - install: ${globals.WP_CLUSTER_PATH}/addons/multisite.jps

  setupBedrockNginx:
    - log: "Setting up Trellis Nginx configuration for Bedrock"
    - install: /scripts/setupNginx.jps?_r=${fn.random}

  installBedrock:
    - log: "Installing Bedrock WordPress"
    - install: /scripts/installBedrock.jps?_r=${fn.random}
      settings:
        db_host: ${globals.DB_HOST}
        db_user: ${globals.DB_USER}
        db_pass: ${globals.DB_PASS}
        redis_host: ${globals.REDIS_HOST}
        redis_port: ${globals.REDIS_PORT}
        wp_admin_pass: ${globals.WP_ADMIN_PASS}
        wp_title: "Hello World"
        wp_url: ${globals.PROTOCOL}://${globals.DOMAIN}/

  setupNodes:
    - log: "Setup Application Node"
    - install: https://raw.githubusercontent.com/jelastic/templates/master/config_v2.jps?_r=${fn.random}
      settings:
        targetGroup: cp
        optimization: wordpress
    - log: "Setup Database Node"
    - cmd[sqldb]: |-
        wget ${baseUrl}/configs/sqldb/wordpress.cnf -O /etc/mysql/conf.d/wordpress.cnf &>> /var/log/run.log || true
        systemctl restart mysql
      user: root
    - log: "Setup Redis Node"
    - cmd[nosqldb]: |-
        echo "maxmemory 256mb" >> /etc/redis.conf
        echo "maxmemory-policy allkeys-lru" >> /etc/redis.conf
        systemctl restart redis
      user: root
        
  createUserDB:
    - log: Create user and database
    - cmd[sqldb]: |-
        echo "Setting up database user and creating wordpress database..."

        # Get MySQL root password from Jelastic
        ROOT_PASS=$(awk -F "=" '/password/ {print $2}' /root/.my.cnf 2>/dev/null | tr -d ' ' | tr -d '\n')

        if [ -z "$ROOT_PASS" ]; then
          # Try alternative location
          ROOT_PASS=$(cat /var/lib/jelastic/keys/password.txt 2>/dev/null | tr -d '\n')
        fi

        if [ -z "$ROOT_PASS" ]; then
          echo "ERROR: Could not find MySQL root password"
          exit 1
        fi

        echo "Found MySQL root password"

        # Create wordpress database
        echo "Creating wordpress database..."
        mysql -uroot -p"$ROOT_PASS" -e "CREATE DATABASE IF NOT EXISTS wordpress CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>&1

        if [ $? -eq 0 ]; then
          echo "Database 'wordpress' created successfully"
        else
          echo "ERROR: Failed to create wordpress database"
          exit 1
        fi

        # Verify database exists
        DB_EXISTS=$(mysql -uroot -p"$ROOT_PASS" -e "SHOW DATABASES LIKE 'wordpress';" | grep wordpress)
        if [ -z "$DB_EXISTS" ]; then
          echo "ERROR: Database 'wordpress' does not exist after creation"
          exit 1
        fi
        echo "Verified: Database 'wordpress' exists"

        # Create user and grant privileges
        echo "Creating user ${globals.DB_USER} and granting privileges..."
        mysql -uroot -p"$ROOT_PASS" -e "CREATE USER IF NOT EXISTS '${globals.DB_USER}'@'%' IDENTIFIED BY '${globals.DB_PASS}';" 2>&1
        mysql -uroot -p"$ROOT_PASS" -e "GRANT ALL PRIVILEGES ON wordpress.* TO '${globals.DB_USER}'@'%';" 2>&1
        mysql -uroot -p"$ROOT_PASS" -e "GRANT ALL PRIVILEGES ON *.* TO '${globals.DB_USER}'@'%';" 2>&1
        mysql -uroot -p"$ROOT_PASS" -e "FLUSH PRIVILEGES;" 2>&1

        # Verify user can access the database
        if mysql -u${globals.DB_USER} -p${globals.DB_PASS} -e "USE wordpress; SELECT 1;" 2>&1 | grep -q "1"; then
          echo "Verified: User ${globals.DB_USER} can access wordpress database"
        else
          echo "ERROR: User ${globals.DB_USER} cannot access wordpress database"
          echo "Testing connection details:"
          mysql -u${globals.DB_USER} -p${globals.DB_PASS} -e "SELECT USER(), DATABASE();" 2>&1
          exit 1
        fi

        # Set Jelastic password
        jem passwd set -p ${globals.DB_PASS} 2>&1 | grep -i "success"

        echo "Database setup completed successfully"
      user: root

  configureRedis:
    - log: Configure Redis for WordPress
    - cmd[nosqldb]: |-
        redis-cli CONFIG SET maxmemory 256mb
        redis-cli CONFIG SET maxmemory-policy allkeys-lru
      user: root
      
  installWoocommerce:
    - log: "Installing WooCommerce for Bedrock"
    - cmd[${nodes.cp.master.id}]: |-
        cd /var/www/webroot/ROOT
        composer require wpackagist-plugin/woocommerce:${globals.version_woocommerce} &>> /var/log/run.log
        wp plugin activate woocommerce --allow-root &>> /var/log/run.log
      user: root

startPage: ${env.url}
